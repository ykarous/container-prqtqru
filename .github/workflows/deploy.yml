name: Deploy
# S'assure qu'un seul d√©ploiement tourne √† la fois
concurrency: deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  Deploy:
    environment: production
    runs-on: ubuntu-latest
    env:
      RUNNING_WITHIN_CI_PIPELINE: 1
      GIT_USERNAME_OR_ORG: ykarous
      GIT_REPO_NAME: container-prqtqru
      APP_NAME: container-prqtqru
      SSH_CONFIG_FILE: /dev/null
      AMBER_SECRET: ${{ secrets.AMBER_SECRET }}
      DOKKU_SSH_PRIVATE_KEY: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

    steps:
      - name: üöÄ Initialisation
        run: |
          echo "üéâ Job d√©clench√© par : ${{ github.event_name }}"
          echo "üêß OS du Runner : ${{ runner.os }}"

      - name: Check out repository code
        uses: actions/checkout@v3

      - name: üîç DIAGNOSTIC MAT√âRIEL (Builder GitHub)
        run: |
          echo "--- INFO PROCESSEUR ---"
          lscpu | grep "Model name"
          echo "--- INFO M√âMOIRE ---"
          free -h
          echo "--- INFO R√âSEAU (Sortie GitHub) ---"
          curl -s https://ipinfo.io/json | jq -r '.org, .city, .country'

      - name: üïµÔ∏è ANALYSE DE LA DESTINATION (Dokku Server)
        run: |
          echo "Recherche de l'adresse du serveur de production..."
          # On cherche l'IP ou le domaine dans le script de d√©ploiement
          TARGET=$(grep -oE '[a-zA-Z0-9.-]+@[a-zA-Z0-9.-]+' ./.container-hosting/deploy.sh | cut -d'@' -f2 | head -n 1)
          if [ -z "$TARGET" ]; then
            echo "‚ö†Ô∏è Adresse IP masqu√©e ou non trouv√©e directement."
          else
            echo "üìç Serveur cible d√©tect√© : $TARGET"
            echo "--- LOCALISATION DU SERVEUR DE PROD ---"
            curl -s https://ipinfo.io/$TARGET/json | jq -r '.org, .city, .region, .country'
          fi

      - name: List files in the repository
        run: |
          ls -la ${{ github.workspace }}

      - name: üö¢ Deploy
        run: |
          set -x
          chmod +x ./.container-hosting/deploy.sh
          ./.container-hosting/deploy.sh
